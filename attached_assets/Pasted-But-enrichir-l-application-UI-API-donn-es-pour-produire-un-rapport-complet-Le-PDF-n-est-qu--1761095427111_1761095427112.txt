But : enrichir lâ€™application (UI + API + donnÃ©es) pour produire un rapport complet. Le PDF nâ€™est quâ€™une vue export de lâ€™Ã©tat de lâ€™app.
âš ï¸ Ne modifiez pas le moteur de calcul si ce nâ€™est pas nÃ©cessaire â€” on expose simplement plus de donnÃ©es et de sections dans lâ€™app, puis on les rÃ©utilise pour lâ€™export.

0) Principes / non-rÃ©gression

Ne changez aucune formule validÃ©e (PV, IR 19 %, PS 17,2 %, abattements, surtaxe).

Conservez la structure des Ã©tapes du wizard.

Ajoutez des sections de rÃ©sultats et des champs cÃ´tÃ© app (UI + API).

Le PDF utilisera exactement ces sections/valeurs sans logique propre.

1) UI (Wizard & RÃ©sultats) â€” AJOUTS OBLIGATOIRES
A) RÃ©sultats (colonne sticky / page â€œRÃ©sultatsâ€)

Ajoutez ces sections dâ€™application dans cet ordre. Chaque section doit Ãªtre visible dans lâ€™app et rafraÃ®chie live quand lâ€™utilisateur modifie un input :

DonnÃ©es gÃ©nÃ©rales

Adresse, Commune + INSEE, DÃ©partement

Type de bien, Dates achat/vente, Prix achat/vente

Surface habitable (â‰¥ 1,80 m), Annexes, DPE (si fournis)

Base dâ€™acquisition (dÃ©taillÃ©e)

Prix dâ€™achat (saisi)

Frais dâ€™acquisition : forfait 7,5 % ou rÃ©el (afficher le montant et la mÃ©thode)

Travaux : forfait 15 % si â‰¥ 5 ans ou rÃ©el (afficher le montant et la mÃ©thode)

Autres coÃ»ts dâ€™achat

Base dâ€™acquisition totale (calculÃ©e)

Plus-value & Abattements

PV brute

DurÃ©e de dÃ©tention : X ans Y mois

Abattement IR (%) et (â‚¬) â€” prÃ©ciser â€œexonÃ©ration IR Ã  22 ansâ€

Abattement PS (%) et (â‚¬) â€” prÃ©ciser â€œexonÃ©ration PS Ã  30 ansâ€

FiscalitÃ©

IR (19 %) : base IR, montant

PrÃ©lÃ¨vements sociaux (17,2 %) : base PS, montant

Surtaxe PV Ã©levÃ©e : montant ou â€œ0 â‚¬ (PV nette â‰¤ 50 000 â‚¬)â€

Total impÃ´ts = IR + PS + surtaxe

Frais de cession & prÃªt (nouvelle zone activable)
Ajoutez une case â€œInclure frais de cession / prÃªtâ€. Si cochÃ©e, affichez :

CRD (capital restant dÃ»)

IRA (afficher la mÃ©thode retenue : % ou 6 mois dâ€™intÃ©rÃªts, et la valeur min)

MainlevÃ©e

Agence (vendeur)

Diagnostics

Prorata taxe fonciÃ¨re

Divers

Net en poche final = Prix de vente âˆ’ Total impÃ´ts âˆ’ (tous frais ci-dessus)

SynthÃ¨se vendeurs

Prix net vendeur (terme marchÃ©, sans impÃ´ts)

Net en poche (avant prÃªt) = Prix âˆ’ impÃ´ts (si la zone prÃªt/frais nâ€™est pas activÃ©e)

Net en poche final (si zone activÃ©e)

RÃ©fÃ©rentiels & versions (lecture seule)

Version barÃ¨mes fiscaux : BOFiP surtaxe (URL + date), Service-Public/impots.gouv (date)

Version DMTO (DGFiP) pour le dÃ©partement (ex. â€œv2025-06â€, URL source)

Localisation & DVF

Commune/INSEE + DÃ©partement

3â€“5 comparables DVF (date, surface ou typologie dispo, prix/mÂ²) + lien dataset

Sâ€™il nâ€™y en a pas : badge â€œAucune donnÃ©e DVF disponible pour cette communeâ€.

Horodatage & Arrondis

Heure locale Europe/Paris (+ afficher UTC en petit)

RÃ¨gle dâ€™arrondi : 2 dÃ©cimales (arrondi commercial)

B) LibellÃ©s (corrections)

Renommer lâ€™actuel â€œNet vendeurâ€ qui soustrayait les impÃ´ts â†’
â€œNet en poche (avant remboursement du prÃªt)â€.

Ajouter une ligne distincte â€œPrix net vendeurâ€ (sans fiscalitÃ©).

2) API â€” Contrats & payloads (sans casser lâ€™existant)
A) EntrÃ©es (dÃ©jÃ  prÃ©sentes pour la plupart)

Assurez-vous que la requÃªte de simulation accepte (et stocke dans DB) :

address, insee_code, dept_code, property_type

purchase_price, purchase_date, sale_price, sale_date

acq_mode (FORFAIT/REEL), acq_amount (si REEL)

works_mode (FORFAIT/REEL/NONE), works_amount (si REEL)

other_acq_amount

Zone frais/ prÃªt (tous optionnels) : crd, ira_mode (PCT/6MOIS), ira_pct, loan_rate_annual, mainlevee, agency_seller, diagnostics, prorata_tf, misc

Surface/DPE : surface_habitable, surface_annexes, dpe_label (optionnel)

B) Sorties (nouveau payload enrichi)

Le POST /simulations/:id/compute doit renvoyer structurÃ© :

{
  "general": {
    "address": "", "insee": "", "dept": "",
    "purchase": {"price": 0, "date": "YYYY-MM-DD"},
    "sale": {"price": 0, "date": "YYYY-MM-DD"},
    "surfaces": {"habitable": 0, "annexes": 0, "dpe": "C"}
  },
  "acquisitionBreakdown": {
    "purchasePrice": 0,
    "acqFees": {"method": "FORFAIT|REEL", "percent": 7.5, "amount": 0},
    "works": {"method": "FORFAIT|REEL|NONE", "percent": 15, "amount": 0, "eligible": true},
    "other": 0,
    "basisTotal": 0
  },
  "plusValue": {
    "pvBrute": 0,
    "holding": {"years": 0, "months": 0}
  },
  "abatements": {
    "ir": {"rate": 0, "amount": 0},
    "ps": {"rate": 0, "amount": 0}
  },
  "taxes": {
    "ir": {"base": 0, "amount": 0, "rate": 19},
    "ps": {"base": 0, "amount": 0, "rate": 17.2},
    "surtaxe": {"amount": 0, "applied": false, "tranche": null}
  },
  "feesAndLoan": {
    "enabled": true,
    "crd": 0, "ira": {"mode": "PCT|6MOIS", "amount": 0, "selected": "min"},
    "mainlevee": 0, "agency": 0, "diagnostics": 0, "prorataTf": 0, "misc": 0
  },
  "nets": {
    "priceNetVendeur": 0,
    "netBeforeLoan": 0,
    "netFinal": 0
  },
  "references": {
    "bofip": {"url": "", "date": "YYYY-MM-DD"},
    "servicePublic": {"url": "", "date": "YYYY-MM-DD"},
    "impotsGouv": {"url": "", "date": "YYYY-MM-DD"},
    "dmto": {"dept": "", "version": "YYYY-MM", "sourceUrl": ""},
    "dvf": {"available": true, "count": 3}
  },
  "meta": {
    "tz": "Europe/Paris", "generatedAtLocal": "YYYY-MM-DDTHH:mm",
    "generatedAtUTC": "YYYY-MM-DDTHH:mm'Z",
    "rounding": "2 decimals, commercial"
  }
}


Important : ce payload applicatif est la source de vÃ©ritÃ©. Le front lâ€™affiche tel quel. Lâ€™export PDF nâ€™est quâ€™un render de ces sections.

3) DonnÃ©es (DB) â€” VÃ©rifier/ajuster

Table simulations contient dÃ©jÃ  les colonnes nÃ©cessaires (cf. version prÃ©cÃ©dente).

Ajoutez si manquants : insee_code, dept_code, dpe_label.

Ajoutez une table de cache dvf_cache si pas encore en place (clÃ©: insee+since+radius).

Gardez dmto_table versionnÃ©e (colonnes version, effective_from, source_url).

4) DVF & DMTO â€” Application (pas PDF)

DMTO : au chargement de la simulation, lire dmto_table par dept_code et afficher dans lâ€™app : â€œDMTO version vYYYY-MM â€” source : [lien]â€.

DVF : crÃ©er une section â€œComparables DVFâ€ dans lâ€™app ; appeler /dvf?insee=&radius=&since= et afficher 3â€“5 ventes (date, prix/mÂ², lien dataset). Si vide â†’ badge â€œAucune donnÃ©eâ€.

5) Horodatage & fuseau â€” Application

Dans lâ€™en-tÃªte de la page RÃ©sultats, afficher :
â€œGÃ©nÃ©rÃ© le JJ/MM/AAAA HH:mm (Europe/Paris) â€” UTC : â€¦â€

Faire lâ€™horodatage cÃ´tÃ© API avec Europe/Paris (et fournir aussi lâ€™UTC).

6) RÃ¨gles dâ€™affichage (arrondis & Ã©tats vides)

Toujours arrondir Ã  2 dÃ©cimales (arrondi commercial).

Si abattements = 0 % : afficher la ligne quand mÃªme (â€œ0 % / 0 â‚¬â€).

Si surtaxe non applicable : afficher â€œ0 â‚¬ (PV nette â‰¤ 50 000 â‚¬)â€.

Si zone â€œFrais de cession / prÃªtâ€ dÃ©sactivÃ©e : masquer la section 5) mais afficher â€œNet en poche (avant prÃªt)â€.

7) Acceptation (au niveau app, pas PDF)

La page RÃ©sultats contient toutes les sections 1â†’9 ci-dessus, dans cet ordre.

Les donnÃ©es calculÃ©es sont cohÃ©rentes avec les rÃ¨gles existantes.

Les versions (BOFiP/Service-Public/impots.gouv/DMTO) sont visibles dans lâ€™app.

DVF affiche 3â€“5 comparables ou un badge dâ€™absence.

Les libellÃ©s â€œPrix net vendeurâ€ / â€œNet en poche (avant prÃªt)â€ / â€œNet en poche finalâ€ sont correctement distinguÃ©s.

Lâ€™horodatage Europe/Paris est prÃ©sent (UTC en petit).

Tous les montants sont arrondis Ã  2 dÃ©cimales.

8) Ã‰tapes concrÃ¨tes (ordre dâ€™implÃ©mentation)

Front : ajouter les sections RÃ©sultats (maquette simple, mÃªme design).

API compute : enrichir le payload exactement comme section 2.B.

DB : migrations mineures pour insee_code, dept_code, dpe_label si absents.

DMTO : affichage version/source dans lâ€™app.

DVF : intÃ©grer la section (placeholder si backend en cours).

Horodatage/Arrondis : normaliser.

Passage QA : vÃ©rifier 3 cas (RS 7 ans ; RP ; PV 55k â†’ surtaxe visible).

ğŸ‘‰ RÃ©sultat attendu : lâ€™utilisateur voit dans lâ€™application toutes les informations dâ€™un rapport pro (sections, montants, versions, DVF, net final).
Lâ€™export PDF ne fera que reprendre ces blocs sans ajouter de logique.

Fin du prompt.

ChatGPT peut commettre des erreurs. Il est recommandÃ© de vÃ©rifier les informations importantes. Voir les